@using BlazorServerAppointmentApp.Model
@using System.Net.Http
@using System.Net.Http.Json
@using System.Text.Json
@using Appointment.Shared.DTO
@using AutoMapper
@inject HttpClient HttpClient
@inject AppSettingsModel Settings
@inject IMapper Mapper

<CascadingValue Value="@this">
    @ChildContent
</CascadingValue>

@code {
    [Parameter]
    public RenderFragment ChildContent { get; set; }
    public event Action OnChange;

    public async Task<List<DoctorViewModel>> GetDoctors()
    {
        Uri uri = new Uri($"{Settings.WebApiUrl}/doctors");
        return Mapper.Map<List<DoctorViewModel>>(await HttpClient.GetFromJsonAsync<DoctorDTO[]>(uri));
    }
    
    public async Task<List<MedicalProcedureViewModel>> GetMedicalProcedures()
    {
        Uri uri = new Uri($"{Settings.WebApiUrl}/medicalprocedures");
        return Mapper.Map<List<MedicalProcedureViewModel>>(await HttpClient.GetFromJsonAsync<MedicalProcedureDTO[]>(uri));
    }
    
    public async Task<List<AppointmentViewModel>> GetAppointments()
    {
        Uri uri = new Uri($"{Settings.WebApiUrl}/appointments");
        return Mapper.Map<List<AppointmentViewModel>>(await HttpClient.GetFromJsonAsync<AppointmentDTO[]>(uri));
    }
    
    private async Task ChangeState()
    {
        OnChange?.Invoke();
    }
}