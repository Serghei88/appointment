@page "/appointments/create"
@using BlazorServerAppointmentApp.Model
@using global::Appointment.Shared.Model
@using Microsoft.AspNetCore.Identity
@inject HttpClient http
@inject NavigationManager UriHelper
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager

<Form ButtonText= "Create appointment"
      OnValidSubmit="@CreateNewAppointment" AppointmentViewModel="@_appointmentViewModel" />
      
      
@code{
      AppointmentViewModel _appointmentViewModel = new AppointmentViewModel();
      protected override async Task OnInitializedAsync()
      {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            
            var user = await UserManager.GetUserAsync(authState.User);

            if (authState.User.Identity.IsAuthenticated && user != null)
            {
                  _appointmentViewModel.User.Email = user.Email;
                  _appointmentViewModel.User.FirstName = user.FirstName;
                  _appointmentViewModel.User.LastName = user.LastName;
                  _appointmentViewModel.User.PhoneNumber = user.PhoneNumber;
            }
      }
  
      async Task CreateNewAppointment()
      {
            // await StateProvider.CreateOrUpdateMedicalProcedure(medicalProcedure);
            UriHelper.NavigateTo($"medicalprocedures");
      }
      
          
      [CascadingParameter]
      StateProvider StateProvider { get; set; }

      protected override void OnInitialized() => StateProvider.OnChange += StateHasChanged;
      public void Dispose() => StateProvider.OnChange -= StateHasChanged;
}
      